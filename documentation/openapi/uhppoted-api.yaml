openapi: "3.0.3"

info:
  version: 0.7.x
  title: "uhppoted"
  description: "REST API for the uhppoted-rest service. The API currently supports both device level functions and higher level access control list management."
  license:
    name: "MIT"
    url: "https://github.com/uhppoted/uhppoted/blob/master/LICENSE"
    
servers:    
  - url: "http://127.0.0.1:8080/uhppote"
  - url: "https://127.0.0.1:8443/uhppote"
  
tags:
  - name: "device"
    description: "Low level device API"
  - name: "acl"
    description: "Access control list API"

security:
  - basic: []
  - hotp: []

paths:
  /device:
    get:
      tags:
        - device
      summary: "Retrieves a list of active devices"
      description: "Retrieves the list of active UHPPOTE devices"
      operationId: listDevices
      responses:
        '200':
          description: "List of active devices"
          content:
            application/json:
              schema:
                  $ref: "./schemas/DeviceList.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}:
    get:
      tags:
        - device
      summary: "Retrieves a single device information"
      description: "Retrieves the basic configuration for a UHPPOTE device"
      operationId: getDevice
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
      responses:
        '200':
          description: "Device configuration"
          content:
            application/json:
              schema:
                type: object
                properties:
                  device:
                    $ref: "./schemas/Device.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
          
  /device/{device-id}/status:
    get:
      tags:
        - device
      summary: "Retrieves the device status"
      description: "Retrieves the current status of a device"
      operationId: getDeviceStatus
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
      responses:
        '200':
          description: "Device current status"
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: "./schemas/DeviceStatus.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/time:
    get:
      tags:
        - device
      summary: "Retrieves the device time"
      description: "Retrieves the device current date/time"
      operationId: getDeviceTime
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
      responses:
        '200':
          description: "Device current date/time"
          content:
            application/json:
              schema:
                  $ref: "./schemas/DeviceTime.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

    put:
      tags:
        - device
      summary: "Sets the device time"
      description: "Sets the device current date/time"
      operationId: putDeviceTime
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
      requestBody:
        description: "Date time"
        required: true
        content:
          application/json:
            schema:
              $ref: "./schemas/DeviceTime.yaml"
      responses:
        '200':
          description: "Device current date/time"
          content:
            application/json:
              schema:
                  $ref: "./schemas/DeviceTime.yaml"
        '403':
          description: "Access denied"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/door/{door}:
    get:
      tags:
        - device
      summary: "Retrieves the door configuration"
      description: "Retrieves the door delay setting and current control state"
      operationId: getDoor
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
        - name: door
          in: path
          description: "Door number"
          required: true
          schema:
            type: integer
            format: uint8
            example: 3
      responses:
        '200':
          description: "Door delay (in seconds)"
          content:
            application/json:
              schema:
                type: object
                properties:
                  door:
                    $ref: "./schemas/Door.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/door/{door}/swipes:
    post:
      tags:
        - device
      summary: "Opens a door"
      description: "Issues the 'open door' command to an access controller"
      operationId: openDoor
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: number
            format: uint32
            example: 405419896
        - name: door
          in: path
          description: "Door number"
          required: true
          schema:
            type: number
            format: uint8
            example: 3
      requestBody:
        content:
          application/json:
            schema:
              $ref: './schemas/CardSwipe.yaml'
      responses:
        '200':
          description: "Door opened"
          content:
            application/json:
              schema:
                type: object
                properties:
                  door:
                    $ref: "./schemas/DoorOpened.yaml"
        '401':
          description: "User does not have permssions to open door"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/door/{door}/delay:
    put:
      tags:
        - device
      summary: "Sets the door delay"
      description: "Sets the door delay in seconds"
      operationId: putDoorDelay
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
        - name: door
          in: path
          description: "Door number"
          required: true
          schema:
            type: integer
            format: uint8
            example: 3
      requestBody:
        description: "Door delay in seconds"
        required: true
        content:
          application/json:
            schema:
              $ref: "./schemas/DoorDelay.yaml"
      responses:
        '200':
          description: "Door delay in seconds"
          content:
            application/json:
              schema:
                  $ref: "./schemas/DoorDelay.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/door/{door}/control:
    put:
      tags:
        - device
      summary: "Sets the door control state"
      description: "Sets the door control state (normally open, normally closed or controlled"
      operationId: putDoorControlState
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
        - name: door
          in: path
          description: "Door number"
          required: true
          schema:
            type: integer
            format: uint8
            example: 3
      requestBody:
        description: "Door control state"
        required: true
        content:
          application/json:
            schema:
              $ref: "./schemas/DoorControlState.yaml"
      responses:
        '200':
          description: "Door control state"
          content:
            application/json:
              schema:
                  $ref: "./schemas/DoorControlState.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/cards:
    get:
      tags:
        - device
      summary: "Retrieves the device card list"
      description: "Retrieves the list of stored card numbers"
      operationId: getCards
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
      responses:
        '200':
          description: "Card list"
          content:
            application/json:
              schema:
                  $ref: "./schemas/CardList.yaml"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

    delete:
      tags:
        - device
      summary: "Deletes the entire device card list"
      description: "Deletes all stored card numbers"
      operationId: deleteCards
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
      responses:
        '200':
          description: "Stored card list cleared"
        '404':
          description: "No device with ID matching device-id"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/card/{card-number}:
    get:
      tags:
        - device
      summary: "Retrieves card access information"
      description: "Retrieves the access permissions associated with a card number"
      operationId: getCard
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
        - name: card-number
          in: path
          description: "Card number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 192837465
      responses:
        '200':
          description: "Card access information"
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: "./schemas/Card.yaml"
        '404':
          description: "No matching device and/or card"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

    put:
      tags:
        - device
      summary: "Adds or updates a card"
      description: "Adds or updates the access permissions associated with a card number"
      operationId: putCard
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
        - name: card-number
          in: path
          description: "Card number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 192837465
      requestBody:
        description: "Card valid dates and access permissions"
        required: true
        content:
          application/json:
            schema:
              $ref: "./schemas/CardDetails.yaml"
      responses:
        '200':
          description: "Card details added/updated"
        '404':
          description: "No matching device and/or card"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

    delete:
      tags:
        - device
      summary: "Deletes a card"
      description: "Removes the card associated with the card number from the stored card list"
      operationId: deleteCard
      parameters:
        - name: device-id
          in: path
          description: "Device serial number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 405419896
        - name: card-number
          in: path
          description: "Card number"
          required: true
          schema:
            type: integer
            format: uint32
            example: 192837465
      responses:
        '200':
          description: "Card deleted"
        '404':
          description: "No matching device and/or card"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '405':
          description: "Invalid request"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        '500':
          description: "Internal system error"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"
        default:
          description: "Request failed"
          content:
            application/json:
              schema:
                  $ref: "./schemas/Error.yaml"

  /device/{device-id}/time-profiles:
    $ref: "./paths/time-profiles.yaml

  /device/{device-id}/time-profile/{time-profile-id}:
    $ref: "./paths/time-profile.yaml

  /device/{device-id}/events:
    $ref: "./paths/events.yaml

  /device/{device-id}/event/{event-id}:
    $ref: "./paths/event.yaml

  /device/{device-id}/special-events:
    $ref: "./paths/record-special-events.yaml
        
  /acl:
    $ref: "./paths/acl.yaml
        
  /acl/card/{card-number}:
    $ref: "./paths/acl-card.yaml

  /acl/card/{card-number}/door/{door}:
    $ref: "./paths/acl-permission.yaml

components:
  securitySchemes:
    basic:
      type: http
      scheme: basic
      description: "RFC 2617 user:password credentials"
    hotp:
      type: http
      scheme: bearer
      bearerFormat: HOTP:user-id:OTP, base64 encoded
      description: "Lightweight user:OTP authorization scheme for IOT devices"
      
  schemas:
      $ref: "./schemas/_index.yaml"